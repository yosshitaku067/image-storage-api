import { mkdir, rm } from "node:fs/promises";
import { resolve } from "node:path";
import { OpenAPIHono } from "@hono/zod-openapi";
import imagesRoute from "../../src/features/images/images.routes";

export const TEST_STORAGE_PATH = resolve(process.cwd(), "test-storage");

/**
 * テスト用のアプリケーションを作成
 */
export const createTestApp = () => {
	const app = new OpenAPIHono();
	app.route("/api/images", imagesRoute);
	return app;
};

/**
 * テスト用のストレージディレクトリをセットアップ
 */
export const setupTestStorage = async () => {
	await rm(TEST_STORAGE_PATH, { recursive: true, force: true });
	await mkdir(TEST_STORAGE_PATH, { recursive: true });
};

/**
 * テスト用のストレージディレクトリをクリーンアップ
 */
export const cleanupTestStorage = async () => {
	await rm(TEST_STORAGE_PATH, { recursive: true, force: true });
};

/**
 * テスト用の画像ファイルを生成（1x1ピクセルのPNG）
 */
export const createTestImageBuffer = (): Buffer => {
	// 1x1 透明PNGの最小データ
	const pngData = Buffer.from([
		0x89, 0x50, 0x4e, 0x47, 0x0d, 0x0a, 0x1a, 0x0a, 0x00, 0x00, 0x00, 0x0d,
		0x49, 0x48, 0x44, 0x52, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
		0x08, 0x06, 0x00, 0x00, 0x00, 0x1f, 0x15, 0xc4, 0x89, 0x00, 0x00, 0x00,
		0x0a, 0x49, 0x44, 0x41, 0x54, 0x78, 0x9c, 0x63, 0x00, 0x01, 0x00, 0x00,
		0x05, 0x00, 0x01, 0x0d, 0x0a, 0x2d, 0xb4, 0x00, 0x00, 0x00, 0x00, 0x49,
		0x45, 0x4e, 0x44, 0xae, 0x42, 0x60, 0x82,
	]);
	return pngData;
};

/**
 * テスト用のJPEG画像ファイルを生成（1x1ピクセル）
 */
export const createTestJpegBuffer = (): Buffer => {
	// 1x1 JPEGの最小データ
	const jpegData = Buffer.from([
		0xff, 0xd8, 0xff, 0xe0, 0x00, 0x10, 0x4a, 0x46, 0x49, 0x46, 0x00, 0x01,
		0x01, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0xff, 0xdb, 0x00, 0x43,
		0x00, 0x03, 0x02, 0x02, 0x03, 0x02, 0x02, 0x03, 0x03, 0x03, 0x03, 0x04,
		0x03, 0x03, 0x04, 0x05, 0x08, 0x05, 0x05, 0x04, 0x04, 0x05, 0x0a, 0x07,
		0x07, 0x06, 0x08, 0x0c, 0x0a, 0x0c, 0x0c, 0x0b, 0x0a, 0x0b, 0x0b, 0x0d,
		0x0e, 0x12, 0x10, 0x0d, 0x0e, 0x11, 0x0e, 0x0b, 0x0b, 0x10, 0x16, 0x10,
		0x11, 0x13, 0x14, 0x15, 0x15, 0x15, 0x0c, 0x0f, 0x17, 0x18, 0x16, 0x14,
		0x18, 0x12, 0x14, 0x15, 0x14, 0xff, 0xc0, 0x00, 0x0b, 0x08, 0x00, 0x01,
		0x00, 0x01, 0x01, 0x01, 0x11, 0x00, 0xff, 0xc4, 0x00, 0x14, 0x00, 0x01,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x09, 0xff, 0xc4, 0x00, 0x14, 0x10, 0x01, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0xff, 0xda, 0x00, 0x08, 0x01, 0x01, 0x00, 0x00, 0x3f, 0x00,
		0x7f, 0xa0, 0xff, 0xd9,
	]);
	return jpegData;
};

/**
 * FormDataにファイルを追加するヘルパー
 */
export const createFormDataWithFile = (
	path: string,
	fileBuffer: Buffer,
	filename: string,
	options?: {
		description?: string;
		tags?: string;
	},
): FormData => {
	const formData = new FormData();
	formData.append("path", path);

	const blob = new Blob([fileBuffer], {
		type:
			filename.endsWith(".jpg") || filename.endsWith(".jpeg")
				? "image/jpeg"
				: "image/png",
	});
	formData.append("file", blob, filename);

	if (options?.description) {
		formData.append("description", options.description);
	}

	if (options?.tags) {
		formData.append("tags", options.tags);
	}

	return formData;
};
